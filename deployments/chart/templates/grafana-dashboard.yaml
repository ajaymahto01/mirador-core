apiVersion: v1
kind: ConfigMap
metadata:
  name: mirador-bleve-grafana-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  mirador-bleve-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "Mirador Core - Bleve Search Performance",
        "tags": ["mirador", "bleve", "search", "performance"],
        "timezone": "browser",
        "panels": [
          {
            "id": 1,
            "title": "Bleve Index Operations Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(mirador_core_bleve_index_operations_total[5m])",
                "legendFormat": "Index Operations/sec"
              }
            ],
            "yAxes": [
              {
                "unit": "ops",
                "format": "short"
              }
            ]
          },
          {
            "id": 2,
            "title": "Bleve Search Operation Duration",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(mirador_core_bleve_search_operation_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, rate(mirador_core_bleve_search_operation_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile"
              }
            ],
            "yAxes": [
              {
                "unit": "seconds",
                "format": "s"
              }
            ]
          },
          {
            "id": 3,
            "title": "Bleve Storage Usage by Tenant",
            "type": "table",
            "targets": [
              {
                "expr": "mirador_core_bleve_storage_memory_usage_bytes + mirador_core_bleve_storage_disk_usage_bytes",
                "legendFormat": "{{tenant}}"
              }
            ],
            "fieldConfig": {
              "overrides": [
                {
                  "matcher": {
                    "id": "byName",
                    "options": "Value"
                  },
                  "properties": [
                    {
                      "id": "unit",
                      "value": "bytes"
                    }
                  ]
                }
              ]
            }
          },
          {
            "id": 4,
            "title": "Bleve Cluster Nodes",
            "type": "stat",
            "targets": [
              {
                "expr": "mirador_core_bleve_cluster_nodes_total",
                "legendFormat": "Active Nodes"
              }
            ]
          },
          {
            "id": 5,
            "title": "Bleve Leadership Changes",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(mirador_core_bleve_cluster_leadership_changes_total[5m])",
                "legendFormat": "Leadership Changes/sec"
              }
            ]
          },
          {
            "id": 6,
            "title": "Bleve Query Cache Hit Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(mirador_core_bleve_cache_operations_total{operation=\"get\",result=\"hit\"}[5m]) / rate(mirador_core_bleve_cache_operations_total{operation=\"get\"}[5m]) * 100",
                "legendFormat": "Cache Hit Rate %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100
              }
            }
          },
          {
            "id": 7,
            "title": "Bleve Cache Operations",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(mirador_core_bleve_cache_operations_total{operation=\"get\",result=\"hit\"}[5m])",
                "legendFormat": "Cache Hits/sec"
              },
              {
                "expr": "rate(mirador_core_bleve_cache_operations_total{operation=\"get\",result=\"miss\"}[5m])",
                "legendFormat": "Cache Misses/sec"
              },
              {
                "expr": "rate(mirador_core_bleve_cache_operations_total{operation=\"set\"}[5m])",
                "legendFormat": "Cache Sets/sec"
              }
            ],
            "yAxes": [
              {
                "unit": "ops",
                "format": "short"
              }
            ]
          },
          {
            "id": 8,
            "title": "Bleve Rebalancing Operations",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(mirador_core_bleve_rebalancing_operations_total{status=\"success\"}[5m])",
                "legendFormat": "Successful Rebalancing/sec"
              },
              {
                "expr": "rate(mirador_core_bleve_rebalancing_operations_total{status=\"failure\"}[5m])",
                "legendFormat": "Failed Rebalancing/sec"
              }
            ],
            "yAxes": [
              {
                "unit": "ops",
                "format": "short"
              }
            ]
          },
          {
            "id": 9,
            "title": "Bleve Index Shards by Tenant",
            "type": "table",
            "targets": [
              {
                "expr": "mirador_core_bleve_index_shard_count",
                "legendFormat": "{{tenant}}"
              }
            ]
          },
          {
            "id": 10,
            "title": "Bleve Document Count by Shard",
            "type": "table",
            "targets": [
              {
                "expr": "mirador_core_bleve_index_document_count",
                "legendFormat": "{{tenant}} - {{shard}}"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "30s"
      }
    }